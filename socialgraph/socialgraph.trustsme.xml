<?xml version="1.0" encoding="UTF-8" ?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
  <meta>
    <author>Paul Tarjan</author>
    <documentationURL>http://code.google.com/apis/socialgraph/docs/lookup.html</documentationURL>
    <sampleQuery>select * from {table} where q = "friendfeed.com/ptarjan"</sampleQuery>
  </meta>
  <bindings>
    <select itemPath="" produces="JSON">
      <urls>
        <url>http://socialgraph.apis.google.com/lookup</url>
      </urls>
      <inputs>
        <key id='q' type='xs:string' paramType='variable' />
      </inputs>
      <execute><![CDATA[
y.include("http://www.json.org/json2.js");
var url = q;
var ret = [];
var checked = [];

var addAlias = function (url) {
    checked.push(url);
    var r = y.rest(request.url).query({
        "q" : url,
        "edi" : "1",
        "fme" : "1",
    }).get().response;
    var json = JSON.parse(r);

    var nodes = json.nodes;
    for (var i in nodes) {
        var node = nodes[i];
        if (ret.indexOf(i) == -1)
            ret.push(i);
    }
}

addAlias(url);

var getNext = function() {
    for (var i in ret) {
        url = ret[i];
        if (checked.indexOf(url) == -1)
            return url;
    }
    return false;
}

while (true) {
    var next = getNext();
    if (! next) break;
    addAlias(next);
}
response.object = {"trustsme" : ret};
      ]]></execute>
    </select>
  </bindings>
</table>
