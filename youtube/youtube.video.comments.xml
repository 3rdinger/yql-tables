<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
  <meta>
    <author>Guilherme Chapiewski &lt;guilherme.chapiewski@gmail.com&gt;</author>
    <sampleQuery>select * from {table} where video_id='zq4A1uCQ1w0'</sampleQuery>
    <sampleQuery>select * from {table} where video_id='zq4A1uCQ1w0' and start_index=51 and max_results=10</sampleQuery>
  </meta>
  <bindings>
    <select itemPath="results.video" produces="XML">
      <urls>
        <url>http://gdata.youtube.com/feeds/api/videos/{video_id}/comments</url>
      </urls>
      <inputs>
        <key id="video_id" type="xs:string" paramType="path" required="true" />
        <key id="start_index" type="xs:integer" paramType="query" required="false" />
        <key id="max_results" type="xs:integer" paramType="query" required="false" />
      </inputs>
      <execute><![CDATA[
        default xml namespace = "http://www.w3.org/2005/Atom";
        var openSearch = Namespace("http://a9.com/-/spec/opensearchrss/1.0/");
        
    		var xml = request.get().response,
  			 	results = <results></results>,
  				comments = <comments></comments>;
  			
  			results.appendChild( <video_id>{video_id}</video_id> );
  			results.appendChild( <title>{xml.title.toString()}</title> );
  			results.appendChild( <total_comments>{xml.openSearch::totalResults}</total_comments> );
  			results.appendChild( <start_index>{xml.openSearch::startIndex}</start_index> );
  			results.appendChild( <items_per_page>{xml.openSearch::itemsPerPage}</items_per_page> );
  			
  			for each(entry in xml.entry) {
  			  var comment = <comment></comment>;
  			  comment.appendChild( <published>{entry.published}</published> );
  			  comment.appendChild( <updated>{entry.updated}</updated> );
  			  comment.appendChild( <title>{entry.title}</title> );
  			  comment.appendChild( <content>{entry.content}</content> );
  			  
  			  var author = <author></author>;
  			  author.appendChild( <name>{entry.author.name}</name> );
  			  author.appendChild( <uri>{entry.author.uri}</uri> );
  			  comment.appendChild(author);
  			  
  			  comments.appendChild(comment);
  			}
  			results.appendChild(comments);
          			
  			response.object = results;
      ]]></execute>
    </select>
  </bindings>
</table>