<?xml version="1.0" encoding="UTF-8" ?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
  <meta>
	<author>Felix Boehm</author>
	<documentationURL>http://www.feedic.com/</documentationURL>
	<sampleQuery>select * from {table} where url="http://www.phoboslab.org/log/2011/06/javascriptcore-project-files-for-ios"</sampleQuery>
  </meta>
  <bindings>
  <select itemPath="" produces="XML">
	<urls>
	  <url></url>
	</urls>
	<inputs>
	  <key id="html" type="xs:string" paramType="variable"/>
	  <key id="url" type="xs:string" paramType="variable"/>
	  <key id="type" type="xs:string" paramType="variable" default="html" />
	  <key id="expand_url" type="xs:string" paramType="variable" default="t" />
	  <key id="linksToSkip" type="xs:string" paramType="variable" default="{}" />
	</inputs>
			<execute><![CDATA[
			//polyfill for object.create (https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object/create#Polyfill)
			if (!Object.create) {
				   Object.create = function (o) {
						function F() {}
						F.prototype = o;
						return new F();
				   };
			}
			
			y.include("https://raw.github.com/FB55/yql-tables/master/readabilitySAX/E4XasSAX.js");
			y.include("https://raw.github.com/FB55/yql-tables/master/readabilitySAX/node_url_module.js");
			y.include("https://raw.github.com/FB55/readabilitySAX/master/readabilitySAX.js");
			
			if(expand_url === "t"){
				y.include("https://raw.github.com/FB55/yql-tables/master/longurl/long_url.js");
				url = getLongURL(url);
			}
			
			var doc;
			
			if(typeof html === "undefined" || !html)
				doc = y.tidy(y.rest(url).get().response);
			else
				doc = y.tidy(html);
			
			linksToSkip = JSON.parse(linksToSkip);
			
			var skipLevel = 0;
			var contentLength = 0;
			var p, r;
			
			while(contentLength < 250 && skipLevel < 4){
				p = {};
				r = readability.process(p,{
					log:function(){y.log.apply(y,arguments)},
					skipLevel: skipLevel,
					linksToSkip: linksToSkip,
					pageURL: url,
					url: node_url_lib
				});
				
				saxParser(doc, p);
				
				contentLength = r.getArticle().textLength;
				skipLevel += 1;
			}
			y.log("got article");
			
			doc = r.getArticle(type);
			doc.url = url;
			
			response.object = doc;
			]]>
			</execute>
	</select>
  </bindings>
</table>