<?xml version="1.0"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
    <meta>
        <author>Paul Tarjan</author>
    </meta>
    <bindings>
        <select produces="XML" itemPath="result.item">
            <urls>
                <url>http://newegg.com</url>
            </urls>
            <inputs>
        		<key id="query" type="xs:string" paramType="query" required="true" />
        		<key id="order" type="xs:string" paramType="query" default="PRICE" />
            </inputs>
            <execute><![CDATA[
var result = <result/>;
var page = 1;
while (true) {

    var html = y.query("select * from html where url='http://www.newegg.com/Product/ProductList.aspx?Submit=ENE&Description=" + (query) + "&Order=" + order + "&Pagesize=100&Page=" + page + "' and xpath='//form[@name=\"formProductListDataGrid\"]//tr[count(td) = 4]'").results;

    if (html.tr.length() == 0) break;
    if (html..h3.(@['class'] == "redtop1")) break;
    page += 1;

    for each (var node in html.tr) {
        var item = <item/>;
        item.name += <name>{node..h3.a.text()}</name>;
        item.link += <link>{node..h3.a.@href}</link>;
        
        var price = node..li.(@['class'] == "ckoutAmt").p.text().toString().replace("Your Price:$", "");
        price = parseFloat(price);
        item.price = <price>{price.toFixed(2)}</price>;

        var shipping = node..li.(@['class'] == "green").p.text().toString();
        if (! /.*Free Shipping.*/.test(shipping)) {
            shipping = shipping.match(/\$[0-9,]\.[0-9]{2}/);
            if (shipping) {
                shipping = shipping.toString().replace("$", "");
                shipping = parseFloat(shipping);
                item.shipping += <shipping>{shipping.toFixed(2)}</shipping>;
            }
        } else {
            shipping = 0;
        }

        var totalPrice = price + shipping;
        item.totalPrice = <totalPrice>{totalPrice.toFixed(2)}</totalPrice>;
        item.image += <image>{node..a.img.(@width == 125).@src}</image>;

        result.item += item;
    }

    // I was always running out of time. Don't do pagination
    break;
}

response.object = result;
            ]]></execute>
        </select>
    </bindings>
</table>
