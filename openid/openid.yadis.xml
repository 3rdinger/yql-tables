<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
    <meta>
        <author>Erik Eldridge</author>
        <description>
            fetch an XRDS document via yadis.  For more info see
            http://openid.net/specs/openid-authentication-2_0.html#discovery
        </description>
        <sampleQuery>select * from {table} where uri="http://www.yahoo.com/"</sampleQuery>
    </meta>
    <bindings>
        <select produces="XML">
            <inputs>
                <key id="id" type="xs:string" paramType="variable" required="true"/>
            </inputs>
            <execute><![CDATA[
                
                // try requesting xrds via header 
                var xrdsReq = y.rest(id),
                    headers = xrdsReq.accept('application/xrds+xml').get().headers,
                    xrdsUri = headers['x-xrds-location'];
                    
                if (xrdsUri) {
                    response.object = {
                        "status" : "success",
                        "uri" : y.xmlToJson(y.rest(xrdsUri).get().response).XRDS.XRD.Service.URI
                    };
                    exit;
                } 
                    
                // try looking for it in the html
                var query = 'select * from html where url="'+id+'" '
                        + 'and xpath=\'//meta[@http-equiv="X-XRDS-Location"]\'',
                    results = y.xmlToJson(y.query(query).results);
                
                if (results) {
                    response.object  = { 
                        "status" : "success", 
                        "uri" : results.results.meta.content 
                    };
                    exit;
                } 
                
                response.object  = {
                    status : 'error',
                    details : 'no openid2 provider defined via yadis for id: ' + id
                };
            ]]></execute>
        </select>
    </bindings>
</table>
