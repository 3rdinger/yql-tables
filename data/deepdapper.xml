<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
  <meta>
    <author>Vic Mortelmans</author>
    <description>The table exctracts data from multiple linked webpages using user-provided dapper queries.</description>
    <sampleQuery>select * from deepdapper where url = "http://www.kerknet.be/zoek_parochie.php?allbisdom=1"
and datadapper = "KerknetParochiesdata"
and nextdapper = "KerknetParochiesdeephtmlnext"
and listdapper = "kerknetparochieslist" </sampleQuery>
    <documentationURL>http://docs.google.com/document/pub?id=14z2qtxjmGV6TaHyuwz9nFJo-p7TwzezANG-VipAhLPg</documentationURL>
  </meta>
  <bindings>
    <select produces="XML" itemPath="">
      <urls>
        <url></url>
      </urls>
      <inputs>
        <key id="url" type="xs:string" paramType="variable" required="true"/>
        <key id="datadapper" type="xs:string" paramType="variable" required="true"/>
        <key id="nextdapper" type="xs:string" paramType="variable" required="false"/>
        <key id="listdapper" type="xs:integer" paramType="variable" required="false"/>
      </inputs>
      <execute><![CDATA[
      var datacalls = [];
      var next = <><item href={url}/></>;  // XML list
      while (next.length() > 0) {
        var listquery = 'select href,content from xml where itemPath="//item" and url="http://www.dapper.net/RunDapp?dappName=$dapper&v=1&applyToUrl=$url"';
        listquery = listquery.replace("$dapper",escape(listdapper));
        listquery = listquery.replace("$url",escape(next[0].@href));
        var list = y.query(listquery).results.*;  // XML list
        y.log("list");
        y.log(list);
        for each (var linkitem in list) {
          var dataquery = 'select * from xml where itemPath="//item" and url="http://www.dapper.net/RunDapp?dappName=$dapper&v=1&applyToUrl=$url"';
          dataquery = dataquery.replace("$dapper",escape(datadapper));
          dataquery = dataquery.replace("$url",escape(linkitem.@href));
          datacalls.push(y.query(dataquery));
        }
        var nextquery = 'select href,content from xml where itemPath="//item" and url="http://www.dapper.net/RunDapp?dappName=$dapper&v=1&applyToUrl=$url"';
        nextquery = nextquery.replace("$dapper",escape(nextdapper));
        nextquery = nextquery.replace("$url",escape(next[0].@href));
        next = y.query(nextquery).results.*;   // XML list
        y.log("next");
        y.log(next);
      }
      var data = <data/>;  // XML
      for each (var datacall in datacalls) {
        y.log(datacall.results.length());
        data.appendChild(datacall.results.*);
      }
      y.log(data);
      response.object = data.*;
]]></execute>
      </select>
  </bindings>
</table>
